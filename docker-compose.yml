version: '3.8'

services:
  # ----------------------------------------------------
  # 1. Base de DonnÃ©es (PostgreSQL)
  # ----------------------------------------------------
  database:
    image: postgres:15-alpine
    container_name: christmas-db
    environment:
      # Credentials de la base de donnÃ©es
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: christmas_gifts
    volumes:
      # Conserve les donnÃ©es de la DB entre les redÃ©marrages
      - db_data:/var/lib/postgresql/data
    restart: always

  # ----------------------------------------------------
  # 2. Backend API (Go)
  # ----------------------------------------------------
  backend:
    # Construit l'image Ã  partir de votre Dockerfile dans ./backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: christmas-api
    # ğŸ¯ JONCTION CLÃ‰ : Permet Ã  l'API de se connecter Ã  la DB interne
    environment:
      # 'database' est le nom du service DB dans Docker Compose
      DATABASE_URL: "postgres://postgres:postgres@database:5432/christmas_gifts?sslmode=disable"
      PORT: 8080
    # S'assure que la DB dÃ©marre avant l'API
    depends_on:
      - database
    restart: always

  # ----------------------------------------------------
  # 3. Frontend (React/Nginx)
  # ----------------------------------------------------
  frontend:
    # Construit l'image Ã  partir de votre Dockerfile dans ./frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: christmas-web
    # ğŸ¯ Mappage finalisÃ© : HÃ´te 5173 -> Conteneur 5173
    ports:
      - "5173:5173"
    # Le frontend a besoin du backend pour les requÃªtes /api
    depends_on:
      - backend
    restart: always

volumes:
  db_data: